@page "/scores"
@using System.Linq
@using SharedModels.Models
@inject BlazorGame.Client.Services.IPlayerService PlayerService
@inject BlazorGame.Client.Services.IPlayerStateService PlayerStateService
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="pixel-container">
    <div class="pixel-header">
        <h1>Tableau des Scores</h1>
        <p>Classement des meilleurs aventuriers du royaume</p>
    </div>

    <div class="scoreboard-section">
        <!-- Section des statistiques -->
        <div class="stats-summary">
            <div class="stat-card">
                <div class="stat-number">@totalPlayers</div>
                <div class="stat-label">Aventuriers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">@totalScore.ToString("N0")</div>
                <div class="stat-label">Points Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">@averageScore.ToString("F1")</div>
                <div class="stat-label">Moyenne</div>
            </div>
        </div>

        <!-- Section du classement général  -->
        <div class="top-players">
            <h3>Top 10 des Héros</h3>
            @if (topPlayers.Any())
            {
                <table class="pixel-table">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Aventurier</th>
                            <th>Type</th>
                            <th>Score</th>
                            <th>Titre</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < topPlayers.Count && i < 10; i++)
                        {
                            var playerVm = topPlayers[i];
                            var rank = i + 1;
                            <tr class="@GetRankClass(rank)">
                                <td>
                                    <span class="rank-badge">
                                        @if (rank == 1) { <text>#1</text> }
                                        else if (rank == 2) { <text>#2</text> }
                                        else if (rank == 3) { <text>#3</text> }
                                        else { <text>@rank</text> }
                                    </span>
                                </td>
                                <td class="player-name">@playerVm.Player.Username</td>
                                <td>@(playerVm.Player.IsAdmin ? "Admin" : "Joueur")</td>
                                @* <td>
                                    <div class="mini-health-bar">
                                        <div class="mini-health-fill" style="width: @playerVm.Player.Health%"></div>
                                        <span class="health-text">@playerVm.Player.Health</span>
                                    </div>
                                </td> *@
                                <td class="score">@playerVm.BestScore.ToString("N0")</td>
                                <td class="title">@GetPlayerTitle(playerVm.BestScore)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="no-players">
                    <h4>Aucun aventurier enregistré</h4>
                    <p>Soyez le premier à vous lancer dans l'aventure !</p>
                </div>
            }
        </div>

        <!-- Section de l'historique personnel -->
        <div class="recent-activity">
            <h3>Mon Historique de Parties</h3>
            @if (currentPlayer == null)
            {
                <p>Aucun joueur connecté.</p>
            }
            else if (loadingHistory)
            {
                <p>Chargement de l'historique...</p>
            }
            else if (!playerGames.Any())
            {
                <p>Aucune partie enregistrée pour <strong>@currentPlayer.Username</strong>.</p>
            }
            else
            {
                <table class="pixel-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Détails</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var game in playerGames)
                        {
                            <tr>
                                <td class="history-text">@game.Date.ToLocalTime().ToString("g")</td>
                                <td class="score">@game.Score</td>
                                <td class="history-text">@game.Details</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <div class="navigation">
        <a class="pixel-btn" href="/">Retour à l'accueil</a>
        <a class="pixel-btn primary" href="/adventure">Partir à l'aventure</a>
        <button class="pixel-btn gold" @onclick="Reload">Actualiser</button>
    </div>
</div>

@code {
    // Classe interne pour combiner les données du joueur et son meilleur score
    private class PlayerScoreViewModel
    {
        public Player Player { get; set; } = new();
        public int BestScore { get; set; }
    }

    // La liste des meilleurs joueurs utilisera notre nouveau modèle
    private List<PlayerScoreViewModel> topPlayers = new();
    private int totalPlayers = 0;
    private int totalScore = 0;
    private double averageScore = 0;

    // Propriétés pour l'historique du joueur
    private Player? currentPlayer;
    private List<AdventureResult> playerGames = new();
    private bool loadingHistory = true;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadGeneralScoreboardAsync(), LoadPlayerHistoryAsync());
    }

    // Charge le classement général en se basant sur le MEILLEUR score
    private async Task LoadGeneralScoreboardAsync()
    {
        // 1. Récupérer tous les joueurs et tous les résultats de parties
        var players = await Task.Run(() => PlayerService.GetAllPlayers());
        var allResults = await PlayerService.GetAllGameResultsAsync();

        // 2. Créer une liste de modèles de vue avec le meilleur score de chaque joueur
        var playerScores = players.Select(p => new PlayerScoreViewModel
        {
            Player = p,
            // On cherche le score maximum dans les résultats pour ce joueur. Si pas de résultat, 0.
            BestScore = allResults.Where(r => r.PlayerId == p.Id).Max(r => (int?)r.Score) ?? 0
        }).ToList();

        // 3. Trier les joueurs par leur meilleur score
        topPlayers = playerScores.OrderByDescending(p => p.BestScore).ToList();

        // Les statistiques globales peuvent rester basées sur le score total si vous le souhaitez
        totalPlayers = players.Count;
        totalScore = players.Sum(p => p.TotalScore);
        averageScore = players.Any() ? players.Average(p => p.TotalScore) : 0;
    }

    // Charge l'historique personnel du joueur connecté
    private async Task LoadPlayerHistoryAsync()
    {
        loadingHistory = true;
        
        // Appel direct et simple à la propriété du service
        currentPlayer = PlayerStateService.CurrentPlayer;

        if (currentPlayer != null)
        {
            // Appel direct et simple à la méthode du service
            var results = await PlayerService.GetGameResultsForPlayerAsync(currentPlayer.Id);
            playerGames = results.ToList();
        }
        
        loadingHistory = false;
    }

    private async Task Reload()
    {
        await OnInitializedAsync();
        StateHasChanged();
    }

    // Les méthodes de style restent inchangées
    string GetRankClass(int rank) =>
        rank switch
        {
            1 => "gold-rank",
            2 => "silver-rank",
            3 => "bronze-rank",
            _ => ""
        };

    string GetPlayerTitle(int score) =>
        score switch
        {
            >= 1000 => "Tueur de Dragons",
            >= 500 => "Maître Guerrier",
            >= 250 => "Chevalier Vaillant",
            >= 100 => "Aventurier Confirmé",
            >= 50 => "Explorateur",
            >= 10 => "Novice",
            _ => "Débutant"
        };
}
<style>
    .scoreboard-section {
        margin-bottom: 30px;
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--pixel-gold);
        color: var(--pixel-dark);
        padding: 20px;
        border: 3px solid var(--pixel-dark);
        text-align: center;
        box-shadow: 3px 3px 0px var(--shadow-color);
    }

    .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .stat-label {
        font-size: 10px;
    }

    .top-players {
        background: var(--pixel-light);
        border: 3px solid var(--pixel-dark);
        padding: 20px;
        margin-bottom: 30px;
    }

    .gold-rank {
        background: linear-gradient(45deg, #FFD700, #FFA500) !important;
        color: var(--pixel-dark) !important;
        font-weight: bold;
    }

    .silver-rank {
        background: linear-gradient(45deg, #C0C0C0, #A8A8A8) !important;
        color: var(--pixel-dark) !important;
        font-weight: bold;
    }

    .bronze-rank {
        background: linear-gradient(45deg, #CD7F32, #B87333) !important;
        color: white !important;
        font-weight: bold;
    }

    .rank-badge {
        font-size: 16px;
        display: inline-block;
        padding: 5px;
    }

    .player-name {
        font-weight: bold;
    }

    .score {
        font-weight: bold;
        color: var(--pixel-gold);
    }

    .title {
        font-size: 10px;
        color: var(--pixel-blue);
    }

    .mini-health-bar {
        background: #333;
        border: 1px solid var(--pixel-dark);
        height: 15px;
        width: 50px;
        position: relative;
        display: inline-block;
    }

    .mini-health-fill {
        background: linear-gradient(90deg, var(--pixel-green), #45a049);
        height: 100%;
        transition: width 0.3s ease;
    }

    .health-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 6px;
        text-shadow: 1px 1px 0px black;
    }

    .no-players {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .recent-activity {
        background: var(--pixel-brown);
        color: var(--pixel-light);
        border: 3px solid var(--pixel-dark);
        padding: 20px;
    }

    .history-text {
        color: var(--pixel-dark); /* Met le texte en noir/foncé */
    }

    .activity-list {
        margin-top: 15px;
    }

    .activity-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 10px;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        font-size: 14px;
        width: 20px;
        text-align: center;
    }

    .navigation {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 3px solid var(--pixel-dark);
    }

    @@media (max-width: 768px) {
        .stats-summary {
            grid-template-columns: 1fr;
        }
        
        .pixel-table {
            font-size: 8px;
        }
        
        .stat-number {
            font-size: 18px;
        }
    }
</style>
