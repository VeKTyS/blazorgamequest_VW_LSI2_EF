@page "/"
@inject BlazorGame.Client.Services.IPlayerService PlayerService
@inject BlazorGame.Client.Services.IPlayerStateService PlayerState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="pixel-container">
    <div class="pixel-header">
        <h1>BlazorGameQuest</h1>
        <p>Bienvenue dans votre aventure pixelisée !</p>
    </div>

    @if (currentPlayer == null)
    {
        <div class="login-section">
            <h3>Connexion</h3>
            
            <div class="login-form">
                <input class="pixel-input" placeholder="Nom d'utilisateur" @bind="username" />
                <input class="pixel-input" placeholder="Mot de passe" type="password" @bind="password" />
                
                <div class="button-group">
                    <button class="pixel-btn primary" @onclick="LoginAsPlayer">
                        Connexion Joueur
                    </button>
                    <button class="pixel-btn gold" @onclick="LoginAsAdmin">
                        Connexion Admin
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(loginMessage))
            {
                <div class="status-message @(loginSuccess ? "success" : "error")">
                    @loginMessage
                </div>
            }

            <div class="demo-info">
                <h4>Comptes de démonstration :</h4>
                <p>Utilisez les comptes suivants :</p>
                <ul>
                    <li>Admin: <b>admin</b> / <b>admin123</b></li>
                    <li>Joueur: <b>player1</b> / <b>password123</b></li>
                </ul>
            </div>
        </div>
    }
    else
    {
        <div class="welcome-section">
            <h3>Bienvenue, @currentPlayer.Username !</h3>
            
            <div class="player-stats">
                <div>
                    <span>Vie: @currentPlayer.Health/100</span>
                    <div class="health-bar">
                        <div class="health-fill" style="width: @currentPlayer.Health%"></div>
                        <div class="health-text">@currentPlayer.Health/100</div>
                    </div>
                </div>
                <div>
                    <span>Score: @currentPlayer.TotalScore</span>
                </div>
                <div>
                    <span>Objets: @currentPlayer.Inventory.Count</span>
                </div>
            </div>

            <div class="action-buttons">
                @if (currentPlayer.IsAdmin)
                {
                    <a class="pixel-btn gold" href="/admin">Administration</a>
                }
                <a class="pixel-btn primary" href="/adventure?playerId=@currentPlayer.Id">Aventure</a>
                <a class="pixel-btn" href="/scores">Scores</a>
                <button class="pixel-btn danger" @onclick="Logout">Déconnexion</button>
            </div>
        </div>
    }
</div>

@code {
    private string username = string.Empty;
    private string password = string.Empty;
    private string loginMessage = string.Empty;
    private bool loginSuccess = false;
    private SharedModels.Models.Player? currentPlayer;

    protected override async Task OnInitializedAsync()
    {
        // Try to restore session from localStorage
        try
        {
            var idStr = await JS.InvokeAsync<string>("localStorage.getItem", "bg_currentPlayerId");
            if (!string.IsNullOrEmpty(idStr) && Guid.TryParse(idStr, out var id))
            {
                var p = PlayerService.GetPlayerById(id);
                if (p != null)
                {
                    currentPlayer = p;
                    PlayerState.SetCurrent(p);
                }
            }
        }
        catch
        {
            // ignore JS errors
        }
    }

    async Task LoginAsPlayer()
    {
        await Login(false);
    }

    async Task LoginAsAdmin()
    {
        await Login(true);
    }

    async Task Login(bool requireAdmin)
    {
        loginMessage = string.Empty;
        loginSuccess = false;

        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            loginMessage = "Veuillez saisir un nom d'utilisateur et un mot de passe.";
            return;
        }

        var player = PlayerService.Authenticate(username, password);
        if (player is null)
        {
            loginMessage = "Identifiants incorrects.";
            return;
        }

        if (requireAdmin && !player.IsAdmin)
        {
            loginMessage = "Droits insuffisants: administrateur requis.";
            return;
        }

        currentPlayer = player;
        PlayerState.SetCurrent(player);
        // persist player id to localStorage so session survives refresh
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "bg_currentPlayerId", player.Id.ToString());
        }
        catch
        {
            // ignore
        }
        loginMessage = "Connexion réussie !";
        loginSuccess = true;
    }

    async Task Logout()
    {
        currentPlayer = null;
        PlayerState.Clear();
        try
        {
            await JS.InvokeVoidAsync("localStorage.removeItem", "bg_currentPlayerId");
        }
        catch { }
        loginMessage = string.Empty;
        username = string.Empty;
        password = string.Empty;
    }
}

<style>
    .login-section {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
    }

    .login-form {
        margin: 20px 0;
    }

    .button-group {
        margin: 20px 0;
    }

    .demo-info {
        background: var(--pixel-brown);
        color: var(--pixel-light);
        padding: 15px;
        border: 3px solid var(--pixel-dark);
        margin: 20px 0;
    }

    .welcome-section {
        text-align: center;
    }

    .action-buttons {
        margin: 20px 0;
    }
</style>