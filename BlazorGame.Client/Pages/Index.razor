@page "/home"
@inject BlazorGame.Client.Services.IPlayerService PlayerService
@inject BlazorGame.Client.Services.IPlayerStateService PlayerState
@inject NavigationManager Nav
@inject Microsoft.Extensions.Configuration.IConfiguration Config
@inject IJSRuntime JS
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider

<div class="pixel-container">
    <div class="auth-banner">
        <AuthorizeView>
            <Authorized>
                <span>Connecté en tant que <strong>@context.User.Identity?.Name</strong></span>
                <button class="pixel-btn danger" style="margin-left:10px" @onclick="LogoutToKeycloak">Se déconnecter</button>
            </Authorized>
            <NotAuthorized>
                <span>Non connecté</span>
                <button class="pixel-btn primary" style="margin-left:10px" @onclick="@(() => Nav.NavigateTo("authentication/login"))">Se connecter</button>
            </NotAuthorized>
        </AuthorizeView>
    </div>
    <div class="pixel-header">
        <h1>BlazorGameQuest</h1>
        <p>Bienvenue dans votre aventure pixelisée !</p>
    </div>

    @if (currentPlayer == null)
    {
        <div class="login-section">
            <h3>Connexion</h3>
            <div class="login-form">
                <input class="form-control" placeholder="Nom d'utilisateur" @bind="username" />
                <input class="form-control" placeholder="Mot de passe" type="password" @bind="password" />
                <div class="button-group">
                    <button class="pixel-btn primary" @onclick="LoginAsPlayer">Connexion joueur</button>
                    <button class="pixel-btn gold" @onclick="LoginAsAdmin">Connexion admin</button>
                </div>
                @if (!string.IsNullOrEmpty(loginMessage))
                {
                    <div class="demo-info">@loginMessage</div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="welcome-section">
            <h3>Bienvenue, @currentPlayer.Username !</h3>
            
            <div class="player-stats">
                <div>
                    <span>Vie: @currentPlayer.Health/100</span>
                    <div class="health-bar">
                        <div class="health-fill" style="width: @currentPlayer.Health%"></div>
                        <div class="health-text">@currentPlayer.Health/100</div>
                    </div>
                </div>
                <div>
                    <span>Score: @currentPlayer.TotalScore</span>
                </div>
                <div>
                    <span>Objets: @currentPlayer.Inventory.Count</span>
                </div>
            </div>

            @if (latestSave != null)
            {
                <div class="latest-save">
                    <h4>Dernière sauvegarde</h4>
                    <p><strong>Date:</strong> @latestSave.PlayedAt.ToLocalTime().ToString("g")</p>
                    <p><strong>Score:</strong> @latestSave.Score</p>
                    <p><strong>Mort:</strong> @(latestSave.IsDead ? "Oui" : "Non")</p>
                    @if (latestSave.Events != null && latestSave.Events.Any())
                    {
                        <div>
                            <strong>Événements récents:</strong>
                            <ul>
                                @foreach (var ev in latestSave.Events)
                                {
                                    <li>@ev</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            }

            <div class="action-buttons">
                @if (currentPlayer.IsAdmin)
                {
                    <a class="pixel-btn gold" href="/admin">Administration</a>
                }
                <a class="pixel-btn primary" href="/adventure?playerId=@currentPlayer.Id">Aventure</a>
                <a class="pixel-btn" href="/scores">Scores</a>
                <button class="pixel-btn danger" @onclick="Logout">Déconnexion</button>
            </div>
        </div>
    }
</div>

@code {
    private string username = string.Empty;
    private string password = string.Empty;
    private string loginMessage = string.Empty;
    private SharedModels.Models.Player? currentPlayer;
    private SharedModels.Models.AdventureResult? latestSave;

    protected override Task OnInitializedAsync()
    {
        // Do not auto-bind to OIDC; show local login form by default
        return Task.CompletedTask;
    }

    async Task LoginAsPlayer()
    {
        await Login(false);
    }

    async Task LoginAsAdmin()
    {
        await Login(true);
    }

    async Task Login(bool requireAdmin)
    {
        loginMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            loginMessage = "Veuillez saisir un nom d'utilisateur et un mot de passe.";
            return;
        }

        var player = PlayerService.Authenticate(username, password);
        if (player is null)
        {
            loginMessage = "Identifiants incorrects.";
            return;
        }

        if (requireAdmin && !player.IsAdmin)
        {
            loginMessage = "Droits insuffisants: administrateur requis.";
            return;
        }

        currentPlayer = player;
        PlayerState.SetCurrent(player);
        // persist player id to localStorage so session survives refresh
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "bg_currentPlayerId", player.Id.ToString());
        }
        catch
        {
            // ignore
        }
        loginMessage = "Connexion réussie !";
    }

    async Task Logout()
    {
        currentPlayer = null;
        PlayerState.Clear();
        try
        {
            await JS.InvokeVoidAsync("localStorage.removeItem", "bg_currentPlayerId");
        }
        catch { }
        loginMessage = string.Empty;
        username = string.Empty;
        password = string.Empty;
        // Build Keycloak logout URL and perform browser POST using JS helper
        var authority = (Config["Oidc:Authority"] ?? string.Empty).TrimEnd('/');
        var clientId = Config["Oidc:ClientId"] ?? string.Empty;
        var postLogout = Nav.BaseUri.TrimEnd('/') + "/loggedout";
        var logoutUrl = $"{authority}/protocol/openid-connect/logout";
        await JS.InvokeVoidAsync("keycloakPostLogout", logoutUrl, postLogout, clientId);
    }

    private async Task LogoutToKeycloak()
    {
        // perform same steps as Logout but keep local cleanup synchronous
        currentPlayer = null;
        PlayerState.Clear();
        loginMessage = string.Empty;
        username = string.Empty;
        password = string.Empty;
        var authority = (Config["Oidc:Authority"] ?? string.Empty).TrimEnd('/');
        var clientId = Config["Oidc:ClientId"] ?? string.Empty;
        var postLogout = Nav.BaseUri.TrimEnd('/') + "/loggedout";
        var logoutUrl = $"{authority}/protocol/openid-connect/logout";
        await JS.InvokeVoidAsync("keycloakPostLogout", logoutUrl, postLogout, clientId);
    }

    private async Task LoadLatestSaveAsync()
    {
        if (currentPlayer == null) return;

        try
        {
            var res = await Http.GetFromJsonAsync<List<SharedModels.Models.AdventureResult>>("api/AdventureResults");
            if (res != null && res.Any())
            {
                latestSave = res.Where(r => r.PlayerId == currentPlayer.Id)
                                 .OrderByDescending(r => r.PlayedAt)
                                 .FirstOrDefault();
            }
        }
        catch
        {
            // ignore load errors for now
        }
    }
}

<style>
    .login-section {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
    }

    .login-form {
        margin: 20px 0;
    }

    .button-group {
        margin: 20px 0;
    }

    .demo-info {
        background: var(--pixel-brown);
        color: var(--pixel-light);
        padding: 15px;
        border: 3px solid var(--pixel-dark);
        margin: 20px 0;
    }

    .welcome-section {
        text-align: center;
    }

    .action-buttons {
        margin: 20px 0;
    }
    .auth-banner {
        padding: 10px;
        border: 2px solid var(--pixel-dark);
        background: var(--pixel-light);
        margin-bottom: 10px;
    }
</style>