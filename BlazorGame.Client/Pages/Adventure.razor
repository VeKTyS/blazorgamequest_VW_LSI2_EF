@page "/adventure"
@inject BlazorGame.Client.Services.IPlayerService PlayerService
@inject BlazorGame.Client.Services.IAdventureService AdventureService
@inject BlazorGame.Client.Services.IPlayerStateService PlayerState
@inject NavigationManager Nav

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "playerId")]
    public Guid? PlayerId { get; set; }
}

<div class="pixel-container">
    <div class="pixel-header">
        <h1>L'Aventure de @(currentPlayer?.Username ?? "Héros Inconnu")</h1>
    </div>

    @if (currentPlayer != null)
    {
        <div class="player-stats">
            <div>
                <span>Vie: @currentPlayer.Health/100</span>
                <div class="health-bar">
                    <div class="health-fill" style="width: @currentPlayer.Health%"></div>
                    <div class="health-text">@currentPlayer.Health/100</div>
                </div>
            </div>
            <div>
                <span>Score: @currentPlayer.TotalScore</span>
            </div>
            <div>
                <span>Objets: @currentPlayer.Inventory.Count</span>
            </div>
        </div>

        @if (currentPlayer.Inventory.Any())
        {
            <div class="inventory">
                <h4>Inventaire:</h4>
                @foreach (var item in currentPlayer.Inventory)
                {
                    <div class="inventory-item">
                        <span>@item.Name</span>
                        <button class="pixel-btn" style="font-size: 8px; padding: 5px;" @onclick="() => UseItem(item)">
                            Utiliser
                        </button>
                    </div>
                }
            </div>
        }

        <div class="adventure-scene">
            @if (AdventureService.CurrentRoom is not null)
            {
                <div class="scene-description">
                    <h3>@AdventureService.CurrentRoom.Name</h3>
                    <p>@AdventureService.CurrentRoom.Description</p>

                    @if (AdventureService.CurrentRoom.Monstres.Any())
                    {
                        <div class="enemy-info">
                            <h4>Ennemi: @AdventureService.CurrentRoom.Monstres.First().Name</h4>
                            <p>PV: @AdventureService.CurrentRoom.Monstres.First().Health - Attaque: @AdventureService.CurrentRoom.Monstres.First().AttackPower</p>
                        </div>
                    }

                    @if (AdventureService.CurrentRoom.Items.Any())
                    {
                        <div class="items-info">
                            <h4>Objets dans la salle:</h4>
                            <ul>
                                @foreach (var it in AdventureService.CurrentRoom.Items)
                                {
                                    <li>@it.Name (@it.ScoreEffect pts, @it.HealthEffect PV)</li>
                                }
                            </ul>
                        </div>
                    }
                </div>

                <div class="action-buttons">
                    @if (AdventureService.IsFinished)
                    {
                        <div class="final-panel">
                            <h3>Donjon terminé !</h3>
                            <button class="pixel-btn primary" @onclick="RestartAdventure">Relancer l'aventure</button>
                            <button class="pixel-btn" @onclick="GoHome">Retour à l'accueil</button>
                            <button class="pixel-btn" @onclick="ViewScores">Voir le classement</button>
                        </div>
                    }
                    else
                    {
                        @if (AdventureService.CurrentRoom.Monstres.Any())
                        {
                            <button class="pixel-btn primary" @onclick="OnAttack">Attaquer</button>
                            <button class="pixel-btn" @onclick="OnFlee">Fuir</button>
                        }
                        else
                        {
                            <button class="pixel-btn" @onclick="OnExplore">Explorer</button>
                        }

                        <button class="pixel-btn gold" @onclick="OnSearch">Fouiller</button>
                        <button class="pixel-btn danger" @onclick="OnRest">Se reposer</button>
                        <button class="pixel-btn" @onclick="OnEnd">Sauvegarder</button>
                    }
                </div>
            }
            else
            {
                <div>Pas de donjon en cours. Cliquez sur <b>Commencer</b>.</div>
                <div class="action-buttons">
                    <button class="pixel-btn primary" @onclick="StartAdventure">Commencer l'aventure</button>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(actionMessage))
        {
            <div class="status-message @(actionSuccess ? "success" : "error")">
                @actionMessage
            </div>
        }

        <div class="navigation">
            <a class="pixel-btn" href="/">Retour à l'accueil</a>
            <a class="pixel-btn" href="/scores">Voir les scores</a>
        </div>
    }
    else
    {
        <div class="error-message">
            <h3>Erreur</h3>
            <p>Joueur non trouvé. Veuillez vous connecter d'abord.</p>
            <a class="pixel-btn primary" href="/">Retour à l'accueil</a>
        </div>
    }
</div>

@code {
    private SharedModels.Models.Player? currentPlayer;
    private string actionMessage = string.Empty;
    private bool actionSuccess = false;

    protected override void OnParametersSet()
    {
        // Prefer player from querystring (explicit) else use logged-in player state
        if (PlayerId.HasValue)
        {
            currentPlayer = PlayerService.GetPlayerById(PlayerId.Value);
        }
        else if (PlayerState.CurrentPlayer != null)
        {
            currentPlayer = PlayerState.CurrentPlayer;
        }

        if (currentPlayer == null)
        {
            Nav.NavigateTo("/");
            return;
        }

        // initialize adventure service with the selected/logged player
        AdventureService.StartAdventure(currentPlayer, rooms: 6);
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
    }

    void StartAdventure()
    {
        if (currentPlayer == null) return;
        AdventureService.StartAdventure(currentPlayer, rooms: 6);
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
        StateHasChanged();
    }

    void OnExplore()
    {
        AdventureService.Explore();
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
        actionSuccess = !AdventureService.IsFinished;
    }

    void OnSearch()
    {
        AdventureService.Search();
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
        actionSuccess = true;
    }

    void OnRest()
    {
        AdventureService.Rest();
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
        actionSuccess = true;
    }

    void OnAttack()
    {
        AdventureService.Attack();
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
        actionSuccess = !AdventureService.IsFinished;
    }

    void OnFlee()
    {
        AdventureService.Flee();
        currentPlayer = AdventureService.CurrentPlayer;
        actionMessage = AdventureService.LastEvent;
        actionSuccess = !AdventureService.IsFinished;
    }

    async Task OnEnd()
    {
        if (AdventureService.IsFinished)
        {
            actionMessage = "Aventure terminée. Sauvegarde en cours...";
        }

        // Save only the result and then go home
        var saved = await AdventureService.SaveResultAsync();
        currentPlayer = AdventureService.CurrentPlayer;
        if (saved)
        {
            actionMessage = "Partie sauvegardée. Retour à l'accueil...";
            actionSuccess = true;
        }
        else
        {
            actionMessage = $"Échec de la sauvegarde. Détail: {AdventureService.LastEvent}";
            actionSuccess = false;
        }

        // redirect home after short pause
        await Task.Delay(500);
        Nav.NavigateTo("/");
    }

    void UseItem(SharedModels.Models.Item item)
    {
        if (currentPlayer == null) return;
        currentPlayer.Health = Math.Min(100, currentPlayer.Health + item.HealthEffect);
        currentPlayer.TotalScore += item.ScoreEffect;
        currentPlayer.Inventory.Remove(item);
        actionMessage = $"Vous utilisez {item.Name}. PV: {currentPlayer.Health}, Score: {currentPlayer.TotalScore}";
        actionSuccess = true;
    }

    void RestartAdventure()
    {
        if (currentPlayer == null) return;
        StartAdventure();
        actionMessage = AdventureService.LastEvent;
        actionSuccess = true;
    }

    void GoHome()
    {
        Nav.NavigateTo("/");
    }

    void ViewScores()
    {
        Nav.NavigateTo("/scores");
    }
}

<style>
    .adventure-scene {
        background: var(--pixel-brown);
        color: var(--pixel-light);
        padding: 20px;
        border: 3px solid var(--pixel-dark);
        margin: 20px 0;
    }

    .scene-description {
        margin-bottom: 20px;
        line-height: 1.8;
    }

    .enemy-info {
        background: var(--pixel-red);
        color: white;
        padding: 15px;
        border: 2px solid var(--pixel-dark);
        margin: 15px 0;
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .navigation {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 3px solid var(--pixel-dark);
    }

    .error-message {
        text-align: center;
        background: var(--pixel-red);
        color: white;
        padding: 20px;
        border: 3px solid var(--pixel-dark);
    }

    @@media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .pixel-btn {
            width: 100%;
            max-width: 300px;
        }
    }
</style>